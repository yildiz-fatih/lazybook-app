<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>user - lazybook</title>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <h1 id="name"></h1>
    <p id="status"></p>

    <!-- Only visible on your own profile -->
    <form id="status-form" style="display:none">
        change status: <input id="status-input">
        <input id="status-submit" type="submit" value="save">
    </form>

    <div id="followinfo"></div>

    <hr>
    <h3>followers</h3>
    <div id="followers" class="list"></div>

    <hr>
    <h3>following</h3>
    <div id="following" class="list"></div>

    <hr>
    <h3>posts</h3>
    <!-- Only if me -->
    <form id="post-form" style="display:none">
        <textarea id="post-contents" maxlength="1024" placeholder="say something..."
            style="width:50%;height:75px;"></textarea><br>
        <button id="post-submit" type="submit">post</button>
    </form>

    <br>

    <div id="user-posts"></div>

    <script src="./common.js"></script>
    <script>
        // --- EARLY EXIT(S) ---
        if (!getToken()) {
            window.location.replace('/login.html');
        }

        const urlParams = new URLSearchParams(window.location.search);
        const userId = parseInt(urlParams.get('id'), 10);

        // --- HELPERS ---
        async function getMeOrRedirect() {
            const me = await getMe();
            if (!me) {
                clearToken();
                window.location.replace('/login.html');
                throw new Error('unauthorized');
            }
            return me;
        }

        function setupFollowButtons(iFollow, followsYou) {
            const el = document.getElementById('followinfo');
            el.innerHTML = '';

            if (followsYou) {
                const p = document.createElement('p');
                p.textContent = 'follows you';
                el.appendChild(p);
            }

            const btn = document.createElement('button');
            btn.textContent = iFollow ? 'unfollow' : 'follow';
            btn.onclick = async () => {
                const res = await authFetch(`${API}/follow`, {
                    method: 'POST',
                    body: JSON.stringify({ whom: userId, action: !iFollow })
                });
                if (!res.ok) { return; }
                loadProfile();
            };
            el.appendChild(btn);
        }

        // --- LOADERS ---
        async function loadUserList(type) { // type is either "following" or "followers"
            const box = document.getElementById(type); // element ID matches type
            box.innerHTML = '';
            const res = await authFetch(`${API}/users/${userId}/${type}`);
            if (!res.ok) { return; }
            const users = await res.json();
            for (const u of users) {
                const a = document.createElement('a');
                a.href = `/user.html?id=${u.id}`;
                a.textContent = u.username;
                box.appendChild(a);
            }
        }

        async function loadUserPosts() {
            const res = await authFetch(`${API}/users/${userId}/posts`);
            if (!res.ok) { return; }
            const items = await res.json();
            const box = document.getElementById('user-posts');
            box.innerHTML = '';
            for (const p of items) box.appendChild(renderPost(p));
        }

        async function loadProfile() {
            // get current user + target profile in parallel
            const [meData, resProfile] = await Promise.all([
                getMeOrRedirect(),
                authFetch(`${API}/users/${userId}`)
            ]);

            if (!resProfile.ok) {
                alert('could not load profile');
                return;
            }
            const prof = await resProfile.json();

            // always display current status
            document.getElementById('status').textContent = prof.status || '';

            // username
            document.getElementById('name').textContent = prof.username;

            const isMe = meData.id === prof.id;

            if (isMe) {
                document.getElementById('status-form').style.display = "";
                document.getElementById('post-form').style.display = "";
                document.getElementById('status-input').value = prof.status || '';
            } else {
                setupFollowButtons(prof.iFollow, prof.follows);
                document.getElementById('status-form').style.display = "none";
                document.getElementById('post-form').style.display = "none";
            }

            loadUserList('followers');
            loadUserList('following');
            loadUserPosts();
        }

        // --- EVENT LISTENERS ---
        document.getElementById('status-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('status-submit');
            btn.disabled = true;
            const statusVal = document.getElementById('status-input').value.trim();

            const res = await authFetch(`${API}/users/status`, {
                method: 'POST',
                body: JSON.stringify({ status: statusVal })
            });

            if (!res.ok) {
                alert('status update failed');
                btn.disabled = false;
                return;
            }

            btn.disabled = false;
            loadProfile();
        });

        document.getElementById('post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('post-submit');
            btn.disabled = true;
            const contents = document.getElementById('post-contents').value.trim();
            if (!contents) { btn.disabled = false; return; }
            const res = await authFetch(`${API}/posts`, { method: 'POST', body: JSON.stringify({ contents }) });
            if (!res.ok) { alert('post failed'); btn.disabled = false; return; }
            document.getElementById('post-contents').value = '';
            btn.disabled = false;
            loadUserPosts();
        });

        // INITIALIZE
        loadProfile();
    </script>
</body>

</html>